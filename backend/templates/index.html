<script>
function renderFinding(f){
  const d = f.details || {};
  const header = (() => {
    let h = `<span class="label">${f.agent}</span> · <span class="muted">${f.label}</span> · <span class="muted">score ${fmtNum(f.score,2)}</span>`;
    h += ` <span class="pill muted">${f.ts_utc}</span>`;
    return h;
  })();

  // helper to map action -> pill class
  const actionPill = (action) => {
    const act = (action || '').toLowerCase();
    const cls = (act === 'consider-entry') ? 'pill-green'
             : (act === 'consider-exit')  ? 'pill-red'
             : (act === 'observe')        ? 'pill-yellow'
             :                              'pill-blue';
    return { act, cls };
  };

  // LLM analysis
  if (f.agent === 'llm_analyst' && d.action){
    const { act, cls } = actionPill(d.action);

    // optional tweaks list
    let tweaks = '';
    if (Array.isArray(d.tweaks) && d.tweaks.length){
      tweaks = `<ul style="margin:6px 0 0 16px">
        ${d.tweaks.slice(0,4).map(t =>
          `<li class="muted">${
            (typeof t === 'string') ? t
              : `${t.param || 'param'}: ${(t.delta ?? 0)}${t.reason ? ' — ' + t.reason : ''}`
          }</li>`).join('')}
      </ul>`;
    }

    return `<div class="finding">
      <div>${header}</div>
      <div style="margin:6px 0 0 2px;">
        <b>Action:</b> <span class="pill ${cls}">${act || 'observe'}</span>
        <span class="muted">conf ${fmtNum(d.confidence,2)}</span>
      </div>
      ${d.rationale ? `<div class="muted" style="margin:4px 0 0 2px">${d.rationale}</div>` : ''}
      ${tweaks}
    </div>`;
  }

  // Trend score formatting
  if (f.agent === 'trend_score'){
    const p = d || {};
    return `<div class="finding">
      <div>${header}</div>
      <div class="muted mono" style="margin-top:4px">
        p_up=${fmtNum(p.p_up,3)} · p_1m=${fmtNum(p.p_1m,3)} · p_5m=${fmtNum(p.p_5m,3)} · p_15m=${fmtNum(p.p_15m,3)}
      </div>
    </div>`;
  }

  // rvol / cvd specific
  if (f.agent === 'rvol_spike'){
    return `<div class="finding"><div>${header}</div>
      <div class="muted" style="margin-top:4px">RVOL=${fmtNum((d||{}).rvol,2)} Vol5=${fmtNum((d||{}).volume_5m,0)}</div>
    </div>`;
  }
  if (f.agent === 'cvd_divergence'){
    return `<div class="finding"><div>${header}</div>
      <div class="muted" style="margin-top:4px">ΔCVD(5m)=${fmtNum((d||{}).delta_5m,2)}</div>
    </div>`;
  }

  // posture guard with same colored pill treatment
  if (f.agent === 'posture_guard' && d.action){
    const { act, cls } = actionPill(d.action);
    return `<div class="finding"><div>${header}</div>
      <div style="margin-top:4px">
        <b>Action:</b> <span class="pill ${cls}">${act || 'observe'}</span>
        <span class="muted">conf ${fmtNum(d.confidence,2)}</span>
      </div>
    </div>`;
  }

  // default
  return `<div class="finding"><div>${header}</div>
    <div class="muted mono" style="margin-top:4px">${JSON.stringify(d).replace(/"/g,'&quot;')}</div>
  </div>`;
}
</script>
