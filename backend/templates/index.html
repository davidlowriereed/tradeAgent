<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Opportunity Radar — Dashboard</title>
  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--muted:#9aa4b2;--text:#e8edf2;--ok:#38d39f;--warn:#f5c451;--bad:#ff6b6b;--blue:#5aa2ff;
      --line:#2a2f3a;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header, footer{position:sticky;z-index:5;background:linear-gradient(180deg,var(--bg),#0f1115f0);backdrop-filter: blur(2px);}
    header{top:0;border-bottom:1px solid var(--line);padding:10px 14px}
    footer{bottom:0;border-top:1px solid var(--line);padding:10px 14px}
    .wrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{font-size:18px;margin:0 8px 0 0}
    select,button,input{background:#0e1117;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    button{cursor:pointer}
    main{height:calc(100vh - 178px); /* header + footer approx */ overflow:auto; padding:10px 14px;}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px}
    .card{background:var(--card);border:1px solid var(--line);padding:12px;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,0.02) inset}
    .title{font-weight:600;margin-bottom:6px}
    .muted{color:var(--muted)}
    .big{font-size:24px;font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .pill{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;border:1px solid var(--line);gap:6px}
    .pill.ok{background:#10291f;border-color:#204d3c;color:#8be8be}
    .pill.bad{background:#321619;border-color:#5b1e26;color:#ff9aa5}
    .pill.warn{background:#332a14;border-color:#6b5214;color:#ffd77a}
    .health{display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:10px}
    .agent{background:var(--card);border:1px solid var(--line);padding:10px;border-radius:10px}
    .agent .ok{color:var(--ok)} .agent .stale{color:var(--bad)}
    .finding{border-bottom:1px dashed var(--line);padding:10px 6px}
    .finding:last-child{border-bottom:none}
    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .top-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:8px 0 10px}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>Opportunity Radar</h1>
    <label class="muted">Symbol</label>
    <select id="symbol"></select>
    <label class="muted">Auto-refresh</label>
    <select id="refresh">
      <option value="3">3s</option>
      <option value="5" selected>5s</option>
      <option value="10">10s</option>
      <option value="30">30s</option>
    </select>
    <button id="run">Run agents now</button>
    <span class="muted" id="status"></span>
    <span style="flex:1"></span>
    <a id="csv" href="#" class="pill"><span>⬇</span><span>Export CSV</span></a>
  </div>

  <div class="cards" style="margin-top:8px">
    <div class="card">
      <div class="title">Trend Score (p_up)</div>
      <div class="big mono" id="p_up">—</div>
      <div class="muted mono" id="p_breakdown">p_1m=— · p_5m=— · p_15m=—</div>
    </div>
    <div class="card">
      <div class="title">Price vs VWAP (bps)</div>
      <div class="big mono" id="pxv">—</div>
      <div class="muted">1m window</div>
    </div>
    <div class="card">
      <div class="title">Momentum</div>
      <div class="row">
        <div><div class="muted">1m</div><div class="big mono" id="mom1">—</div></div>
        <div><div class="muted">5m</div><div class="big mono" id="mom5">—</div></div>
      </div>
    </div>
    <div class="card">
      <div class="title">RVOL (5 vs 20)</div>
      <div class="big mono" id="rvol">—</div>
      <div class="muted">bar-based</div>
    </div>
  </div>
</header>

<main>
  <div class="title" style="margin:6px 0 8px 4px;">Latest Findings</div>
  <div id="findings"></div>
</main>

<footer>
  <div class="cards">
    <div class="card">
      <div class="title">Top of Book</div>
      <div class="row mono"><div>Bid</div><div id="bb">—</div></div>
      <div class="row mono"><div>Ask</div><div id="ba">—</div></div>
    </div>
    <div class="card">
      <div class="title">Trades Cached</div>
      <div class="big mono" id="cached">0</div>
    </div>
    <div class="card">
      <div class="title">Liquidity</div>
      <div id="liq" class="pill"><span>⏳</span><span>Loading…</span></div>
    </div>
    <div class="card">
      <div class="title">LLM Netcheck</div>
      <div id="net" class="pill"><span>⏳</span><span>Checking…</span></div>
    </div>
  </div>

  <div class="title" style="margin:12px 0 8px 4px;">Agent Health</div>
  <div class="health" id="health"></div>
</footer>

<script>
(() => {
  // ---------- small helpers ----------
  const $  = s => document.querySelector(s);
  const esc = s => String(s ?? '').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const fmt = (x, d=2) => (Number.isFinite(+x) ? (+x).toFixed(d) : '—');
  const bps = x => (Number.isFinite(+x) ? String(Math.round(+x)) : '—');
  const pct = x => (Number.isFinite(+x) ? String(Math.round(+x*100)) : '—');
  const ago = ts => { const t=new Date(ts), s=Math.max(0,(Date.now()-t)/1000); return s<60?`${s|0}s ago`:s<3600?`${(s/60)|0}m ago`:`${(s/3600)|0}h ago`; };

  // ---------- element refs (match your markup) ----------
  const elSymbol = $('#symbol');
  const elRefresh = $('#refresh');
  const elCSV = $('#csv');
  const elStatus = $('#status');

  const elPUp = $('#p_up');
  const elPBreak = $('#p_breakdown');

  const elPxV = $('#pxv');
  const elMom1 = $('#mom1');
  const elMom5 = $('#mom5');
  const elRvol = $('#rvol');

  const elBid = $('#bb');
  const elAsk = $('#ba');
  const elCached = $('#cached');

  const elFindings = $('#findings');
  const elHealth = $('#health');
  const elLiq = $('#liq');
  const elNet = $('#net');

  let timers = [];
  const clearTimers = () => { timers.forEach(clearInterval); timers = []; };

  // ---------- request wrapper ----------
  async function jget(path, params={}) {
    const u = new URL(path, window.location.origin);
    Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
    const r = await fetch(u.toString(), { cache: 'no-cache' });
    const ct = r.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
      const t = await r.text();
      throw new Error(`Non-JSON ${r.status}: ${t.slice(0,160)}`);
    }
    return r.json();
  }

  // ---------- symbol init ----------
  async function initSymbols() {
    const h = await jget('/health');
    const symbols = h.symbols || [];
    elSymbol.innerHTML = symbols.map(s => `<option>${s}</option>`).join('');
    // initial symbol from query string (if any)
    const url = new URL(window.location.href);
    const qs = url.searchParams.get('symbol');
    if (qs && symbols.includes(qs)) elSymbol.value = qs;
    updateCSVLink();
  }

  function updateCSVLink() {
    elCSV.href = `/export-csv?symbol=${encodeURIComponent(elSymbol.value)}&limit=500`;
  }

  // ---------- tiles ----------
  async function updateSignals() {
    const symbol = elSymbol.value;
    const s = await jget('/signals', {symbol});
    elBid.textContent = fmt(s.best_bid, 2);
    elAsk.textContent = fmt(s.best_ask, 2);
    elCached.textContent = Number(s.trades_cached || 0);
    // we prefer momentum from /signals_tf for both 1m & 5m (consistent source)
  }

  async function updateSignalsTF() {
    const symbol = elSymbol.value;
    const tf = await jget('/signals_tf', {symbol});
    elMom1.textContent = bps(tf.mom_bps_1m);
    elMom5.textContent = bps(tf.mom_bps_5m);
    elPxV.textContent  = bps(tf.px_vs_vwap_bps_1m);
    const r = tf.rvol_1m ?? tf.rvol_5m ?? 0;
    elRvol.textContent = Number.isFinite(+r) ? (+r).toFixed(2) : '—';
  }

  async function updateTrend() {
    const symbol = elSymbol.value;
    // try DB finding first
    try {
      const f = await jget('/findings', {symbol, agent: 'trend_score', limit: 1});
      if (f.findings && f.findings.length) {
        const row = f.findings[0] || {};
        const d = row.details || {};
        elPUp.textContent = pct(d.p_up ?? row.score);
        elPBreak.textContent = `p_1m=${pct(d.p_1m)} · p_5m=${pct(d.p_5m)} · p_15m=${pct(d.p_15m)}`;
        return;
      }
    } catch {}
    // live fallback
    try {
      const t = await jget('/trend_now', {symbol});
      elPUp.textContent = pct(t.p_up);
      elPBreak.textContent = `p_1m=${pct(t.p_1m)} · p_5m=${pct(t.p_5m)} · p_15m=${pct(t.p_15m)}`;
    } catch {
      elPUp.textContent = '—';
      elPBreak.textContent = 'p_1m=— · p_5m=— · p_15m=—';
    }
  }

  function renderFinding(f) {
    const d = f.details || {};
    const hdr = `<b>${esc(f.label || f.agent)}</b> • <span class="mono">${fmt(f.score,1)}</span> • <span class="muted mono">${new Date(f.ts_utc).toLocaleTimeString()}</span>`;
    if (f.agent === 'trend_score') {
      return `<div class="finding"><div>${hdr}</div>
        <div class="muted mono" style="margin-top:4px">p_up=${fmt(d.p_up,3)} · p_1m=${fmt(d.p_1m,3)} · p_5m=${fmt(d.p_5m,3)} · p_15m=${fmt(d.p_15m,3)}</div>
      </div>`;
    }
    if (f.agent === 'rvol_spike') {
      const rv = d.rvol_1m5_vs20 ?? d.rvol ?? d.rvol_1m;
      const m1 = d.mom_bps_1m ?? d.mom1_bps;
      const vx = d.px_vs_vwap_bps_1m ?? d.px_vs_vwap_bps;
      return `<div class="finding"><div>${hdr}</div>
        <div class="muted" style="margin-top:4px">RVOL=${fmt(rv,2)} · mom1=${bps(m1)} · px-vwap=${bps(vx)}</div>
      </div>`;
    }
    return `<div class="finding"><div>${hdr}</div></div>`;
  }

  async function updateFindings() {
    const symbol = elSymbol.value;
    const res = await jget('/findings', {symbol, limit: 50});
    const list = Array.isArray(res.findings) ? res.findings : [];
    elFindings.innerHTML = list.map(renderFinding).join('') || '<div class="muted">No findings yet.</div>';
  }

  async function updateHealth() {
    const h = await jget('/agents');
    const now = Date.now();
    const stale = 60; // s
    elHealth.innerHTML = (h.agents || []).map(rec => {
      const age = rec.last_run ? (now - new Date(rec.last_run).getTime())/1000 : 9e9;
      const cls = age > stale ? 'stale' : 'ok';
      const label = age > stale ? 'STALE' : 'OK';
      return `<div class="agent">
        <div class="row"><div><b>${esc(rec.agent)}</b></div><div class="${cls}">${label}</div></div>
        <div class="muted" style="margin-top:6px">Last run: ${rec.last_run ? ago(rec.last_run) : '—'}</div>
      </div>`;
    }).join('');
  }

  async function updateLiq() {
    try{
      const j = await jget('/liquidity');
      elLiq.className = 'pill ' + (j.risk_on ? 'ok' : 'warn');
      elLiq.innerHTML = j.risk_on ? '<span>✅</span><span>Risk-on</span>' : '<span>⚠️</span><span>Risk-off</span>';
    }catch{
      elLiq.className = 'pill bad';
      elLiq.innerHTML = '<span>⚠️</span><span>Unavailable</span>';
    }
  }

  async function updateNet() {
    try { await fetch('/llm/netcheck', {cache: 'no-cache'}); elNet.className='pill ok'; elNet.innerHTML='<span>✅</span><span>OpenAI OK</span>'; }
    catch { elNet.className='pill bad'; elNet.innerHTML='<span>⚠️</span><span>OpenAI unreachable</span>'; }
  }

  // ---------- run now ----------
  async function runAgentsNow() {
    const symbol = elSymbol.value;
    elStatus.textContent = 'Running…';
    try {
      const names = ['rvol_spike','cvd_divergence','trend_score','llm_analyst'].join(',');
      const u = `/agents/run-now?insert=true&symbol=${encodeURIComponent(symbol)}&names=${encodeURIComponent(names)}`;
      const r = await fetch(u, { method: 'POST' });
      if (!r.ok) throw new Error(await r.text());
      elStatus.textContent = 'Agents run';
      setTimeout(()=> elStatus.textContent='', 2500);
      // force a quick refresh of findings
      updateFindings();
    } catch (e) {
      console.error(e);
      elStatus.textContent = 'Run failed';
    }
  }

  // ---------- loop control ----------
  function resetLoops() {
    clearTimers();
    updateCSVLink();
    // prime once
    updateSignals(); updateSignalsTF(); updateTrend(); updateFindings(); updateHealth(); updateLiq(); updateNet();
    // schedule
    const iv = (+elRefresh.value || 5) * 1000;
    timers.push(setInterval(updateSignals,   iv));
    timers.push(setInterval(updateSignalsTF, iv));
    timers.push(setInterval(updateTrend,     Math.max(10_000, iv)));
    timers.push(setInterval(updateFindings,  iv));
    timers.push(setInterval(updateHealth,    15_000));
    timers.push(setInterval(updateLiq,       60_000));
    timers.push(setInterval(updateNet,       60_000));
  }

  // ---------- boot ----------
  (async function boot(){
    await initSymbols();
    resetLoops();
    elSymbol.addEventListener('change', () => {
      const url = new URL(window.location.href);
      url.searchParams.set('symbol', elSymbol.value);
      history.replaceState(null,'',url.toString());
      resetLoops();
    });
    elRefresh.addEventListener('change', resetLoops);
    $('#run').addEventListener('click', runAgentsNow);
  })();
})();
</script>
</body>
</html>
