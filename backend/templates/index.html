<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Opportunity Radar (Alpha)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; color: #111;}
    .grid { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 16px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h1 { margin: 0 0 16px 0; }
    h2 { margin: 8px 0; font-size: 16px; color: #444; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .ok { color: #0a9b4c; font-weight: 600; }
    .stale { color: #b97b00; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .small { color: #555; font-size: 12px; }
    .findings { height: 380px; overflow: auto; border: 1px solid #eee; border-radius: 10px; padding: 8px; }
    .muted { color: #777; }
    @media (max-width: 1100px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Opportunity Radar (Alpha) <select id="symbol"></select></h1>
  <div class="grid">
    <div class="card">
      <h2>Cumulative Volume Delta (CVD)</h2>
      <div class="mono" id="cvd">—</div>
    </div>
    <div class="card">
      <h2>5-min Volume</h2>
      <div class="mono" id="vol">—</div>
      <div class="small muted">RVOL vs recent: <span id="rvol">—</span></div>
    </div>
    <div class="card">
      <h2>Best Bid / Ask</h2>
      <div class="mono"><span id="bid">—</span> / <span id="ask">—</span></div>
    </div>
    <div class="card">
      <h2>Trades Cached</h2>
      <div class="mono" id="tc">—</div>
    </div>
  </div>

  <h2>Latest Findings</h2>
  <div class="findings mono" id="findings">loading…</div>

  <h2>Agent Health</h2>
  <div class="grid" id="health"></div>

  <p class="small muted">API: <a href="/signals">/signals</a> · Health: <a href="/health">/health</a> · Agents: <a href="/agents">/agents</a></p>

<script>
const symSel = document.getElementById('symbol');
let SYMBOLS = [];

async function fetchJSON(url) {
  const r = await fetch(url);
  return r.json();
}

async function loadSymbols() {
  const h = await fetchJSON('/health');
  SYMBOLS = h.symbols || ["BTC-USD"];
  SYMBOLS.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s;
    symSel.appendChild(opt);
  });
}

async function refresh() {
  const symbol = symSel.value || SYMBOLS[0];

  const sig = await fetchJSON('/signals?symbol=' + encodeURIComponent(symbol));
  document.getElementById('cvd').textContent = (sig.cvd ?? '—').toLocaleString(undefined, {maximumFractionDigits: 4});
  document.getElementById('vol').textContent = (sig.volume_5m ?? '—').toLocaleString();
  document.getElementById('rvol').textContent = (sig.rvol_vs_recent ?? 0).toFixed(2) + 'x';
  document.getElementById('bid').textContent = sig.best_bid ?? '—';
  document.getElementById('ask').textContent = sig.best_ask ?? '—';
  document.getElementById('tc').textContent = sig.trades_cached ?? '—';

  const f = await fetchJSON('/findings?symbol=' + encodeURIComponent(symbol) + '&limit=80');
  const el = document.getElementById('findings');
  el.innerHTML = '';
  (f.findings || []).forEach(it => {
    const div = document.createElement('div');
    let head = `${it.agent} · ${it.label} · score ${Number(it.score).toFixed(2)}\n${it.ts_utc}`;
    let det = '';
    try {
      const d = it.details || {};
      if (it.agent === 'llm_analyst') {
        det = `\nAction: ${d.action} (conf ${(d.confidence ?? 0).toFixed(2)})\n${d.rationale || ''}`;
        const t = d.tweaks || [];
        if (t.length) det += '\n• tweaks: ' + JSON.stringify(t);
      } else if (it.agent === 'trend_score') {
        det = `\np_up: ${(d.p_up*100).toFixed(1)}%`;
      } else if (it.agent === 'rvol_spike') {
        det = `\nRVOL: ${((d.rvol)||0).toFixed(2)}x`;
      } else if (it.agent === 'cvd_divergence') {
        det = `\nΔCVD(5m): ${d.delta_5m}`;
      } else if (it.agent === 'posture_guard') {
        det = `\nAction: ${d.action} — ${ (d.reasons||[]).join('; ') }`;
      }
    } catch(e){}
    div.textContent = head + det + '\n';
    el.appendChild(div);
  });

  const hl = await fetchJSON('/health');
  const hg = document.getElementById('health');
  hg.innerHTML = '';
  const now = Date.now();
  (Object.entries(hl.agents || {})).forEach(([name, obj]) => {
    const card = document.createElement('div');
    card.className = 'card';
    const ts = new Date(obj.last_run).getTime();
    const age = (now - ts)/1000;
    const statusCls = age <= 120 ? 'ok' : 'stale';
    card.innerHTML = `<h2>${name}</h2><div class="${statusCls}">${statusCls.toUpperCase()}</div><div class="small muted">Last run: ${obj.last_run}</div>`;
    hg.appendChild(card);
  });
}

(async () => {
  await loadSymbols();
  symSel.value = SYMBOLS[0];
  await refresh();
  setInterval(refresh, 4000);
  symSel.addEventListener('change', refresh);
})();
</script>
</body>
</html>
