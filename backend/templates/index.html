<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Opportunity Radar — Dashboard</title>
  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--muted:#9aa4b2;--text:#e8edf2;--ok:#38d39f;--warn:#f5c451;--bad:#ff6b6b;--blue:#5aa2ff;
      --line:#2a2f3a;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header, footer{position:sticky;z-index:5;background:linear-gradient(180deg,var(--bg),#0f1115f0);backdrop-filter: blur(2px);}
    header{top:0;border-bottom:1px solid var(--line);padding:10px 14px}
    footer{bottom:0;border-top:1px solid var(--line);padding:10px 14px}
    .wrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{font-size:18px;margin:0 8px 0 0}
    select,button,input{background:#0e1117;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    button{cursor:pointer}
    main{height:calc(100vh - 178px); /* header + footer approx */ overflow:auto; padding:10px 14px;}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px}
    .card{background:var(--card);border:1px solid var(--line);padding:12px;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,0.02) inset}
    .title{font-weight:600;margin-bottom:6px}
    .muted{color:var(--muted)}
    .big{font-size:24px;font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .pill{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;border:1px solid var(--line);gap:6px}
    .pill.ok{background:#10291f;border-color:#204d3c;color:#8be8be}
    .pill.bad{background:#321619;border-color:#5b1e26;color:#ff9aa5}
    .pill.warn{background:#332a14;border-color:#6b5214;color:#ffd77a}
    .health{display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:10px}
    .agent{background:var(--card);border:1px solid var(--line);padding:10px;border-radius:10px}
    .agent .ok{color:var(--ok)} .agent .stale{color:var(--bad)}
    .finding{border-bottom:1px dashed var(--line);padding:10px 6px}
    .finding:last-child{border-bottom:none}
    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .top-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:8px 0 10px}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>Opportunity Radar</h1>
    <label class="muted">Symbol</label>
    <select id="symbol"></select>
    <label class="muted">Auto-refresh</label>
    <select id="refresh">
      <option value="3">3s</option>
      <option value="5" selected>5s</option>
      <option value="10">10s</option>
      <option value="30">30s</option>
    </select>
    <button id="run">Run agents now</button>
    <span class="muted" id="status"></span>
    <span style="flex:1"></span>
    <a id="csv" href="#" class="pill"><span>⬇</span><span>Export CSV</span></a>
  </div>

  <div class="cards" style="margin-top:8px">
    <div class="card">
      <div class="title">Trend Score (p_up)</div>
      <div class="big mono" id="p_up">—</div>
      <div class="muted mono" id="p_breakdown">p_1m=— · p_5m=— · p_15m=—</div>
    </div>
    <div class="card">
      <div class="title">Price vs VWAP (bps)</div>
      <div class="big mono" id="pxv">—</div>
      <div class="muted">1m window</div>
    </div>
    <div class="card">
      <div class="title">Momentum</div>
      <div class="row">
        <div><div class="muted">1m</div><div class="big mono" id="mom1">—</div></div>
        <div><div class="muted">5m</div><div class="big mono" id="mom5">—</div></div>
      </div>
    </div>
    <div class="card">
      <div class="title">RVOL (5 vs 20)</div>
      <div class="big mono" id="rvol">—</div>
      <div class="muted">bar-based</div>
    </div>
  </div>
</header>

<main>
  <div class="title" style="margin:6px 0 8px 4px;">Latest Findings</div>
  <div id="findings"></div>
</main>

<footer>
  <div class="cards">
    <div class="card">
      <div class="title">Top of Book</div>
      <div class="row mono"><div>Bid</div><div id="bb">—</div></div>
      <div class="row mono"><div>Ask</div><div id="ba">—</div></div>
    </div>
    <div class="card">
      <div class="title">Trades Cached</div>
      <div class="big mono" id="cached">0</div>
    </div>
    <div class="card">
      <div class="title">Liquidity</div>
      <div id="liq" class="pill"><span>⏳</span><span>Loading…</span></div>
    </div>
    <div class="card">
      <div class="title">LLM Netcheck</div>
      <div id="net" class="pill"><span>⏳</span><span>Checking…</span></div>
    </div>
  </div>

  <div class="title" style="margin:12px 0 8px 4px;">Agent Health</div>
  <div class="health" id="health"></div>
</footer>

<script>
  (() => {
// ---- DOM helpers ----
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  //const fmtNum = (x, d=2) => (x===null||x===undefined||isNaN(+x)) ? "—" : (+x).toLocaleString(undefined,{maximumFractionDigits:d});
  const ago = ts => { const t=new Date(ts), s=Math.max(0,(Date.now()-t.getTime())/1000); return s<60?`${s|0}s ago`:s<3600?`${(s/60)|0}m ago`:`${(s/3600)|0}h ago`; };
  const esc = s => String(s ?? '').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

  let SYMBOLS=[], current=null, timers=[];
  function clearTimers(){ timers.forEach(clearInterval); timers=[]; }

  // Elements (adjust IDs to yours)
  const selSymbol   = $('#symbol-select');   // <select id="symbol-select">BTC-USD...</select>
  const cardTrend   = $('#trend-pup');       // main value
  const cardP1m     = $('#trend-p1m');
  const cardP5m     = $('#trend-p5m');
  const cardP15m    = $('#trend-p15m');

  const cardPxv1m   = $('#pxv-1m');          // “Price vs VWAP (bps)”
  const cardMom1m   = $('#mom-1m');
  const cardMom5m   = $('#mom-5m');
  const cardRvol    = $('#rvol-5v20');       // RVOL tile

  const bestBidEl   = $('#best-bid');
  const bestAskEl   = $('#best-ask');
  const tradesEl    = $('#trades-cached');

  const findingsList = $('#findings-list');  // <ul id="findings-list">

   // ---- symbol state ----
  function getSymbol() {
    const s = selSymbol?.value?.trim();
    return s || 'BTC-USD';
  }

  function setSymbol(sym) {
    if (selSymbol) selSymbol.value = sym;
    // persist in query string so refresh preserves selection
    const url = new URL(window.location.href);
    url.searchParams.set('symbol', sym);
    history.replaceState(null, '', url.toString());
    // immediately refresh everything for the new symbol
    refreshAll(true);
  }

  if (selSymbol) {
    selSymbol.addEventListener('change', () => setSymbol(getSymbol()));
  }

  // initialize from ?symbol=...
  (function initSymbolFromURL(){
    const url = new URL(window.location.href);
    const s = url.searchParams.get('symbol');
    if (s) setSymbol(s);
  })();
  
async function init(){
  const h = await (await fetch('/health')).json();
  SYMBOLS = h.symbols || [];
  const sel = $('#symbol'); sel.innerHTML = SYMBOLS.map(s=>`<option>${s}</option>`).join('');
  current = SYMBOLS[0] || null;
  sel.value = current;
  $('#csv').href = `/export-csv?symbol=${encodeURIComponent(current)}&limit=500`;
  $('#refresh').addEventListener('change', resetLoops);
  $('#symbol').addEventListener('change', e=>{ current=e.target.value; $('#csv').href=`/export-csv?symbol=${encodeURIComponent(current)}&limit=500`; resetLoops(); });
  $('#run').addEventListener('click', runAgentsNow);
  resetLoops();
}

function resetLoops(){
  clearTimers();
  const iv = (+$('#refresh').value||5)*1000;
  fetchTop(); fetchFindings(); fetchHealth(); netcheck(); fetchLiquidity();
  timers.push(setInterval(fetchTop, iv));
  timers.push(setInterval(fetchFindings, iv));
  timers.push(setInterval(fetchHealth, 15000));
  timers.push(setInterval(netcheck, 30000));
  timers.push(setInterval(fetchLiquidity, 60000));
}

async function runAgentsNow(){
  $('#status').textContent = 'Running…';
  try{
    const r = await fetch('/agents/run-now', {method:'POST'});
    if(!r.ok) throw new Error(await r.text());
    $('#status').textContent = 'Agents run';
    setTimeout(()=>$('#status').textContent='', 2500);
  }catch(e){
    console.error(e); $('#status').textContent = 'Run failed';
  }
}

async function netcheck(){
  try{
    const r = await fetch('/llm/netcheck');
    const ok = r.ok;
    $('#net').className = 'pill ' + (ok?'ok':'bad');
    $('#net').innerHTML = ok ? '<span>✅</span><span>OpenAI OK</span>' : '<span>⚠️</span><span>OpenAI unreachable</span>';
  }catch(e){
    $('#net').className = 'pill bad';
    $('#net').innerHTML = '<span>⚠️</span><span>OpenAI unreachable</span>';
  }
}

async function fetchLiquidity(){
  try{
    const r = await fetch('/liquidity');
    const j = await r.json();
    const cls = j.risk_on ? 'ok' : 'warn';
    $('#liq').className = 'pill '+cls;
    $('#liq').innerHTML = j.error ? `<span>⚠️</span><span>Error</span>` : (j.risk_on ? '<span>✅</span><span>Risk-on</span>' : '<span>⚠️</span><span>Risk-off</span>');
  }catch(e){
    $('#liq').className = 'pill bad';
    $('#liq').innerHTML = '<span>⚠️</span><span>Unavailable</span>';
  }
}

async function fetchTop(){
  if(!current) return;
  try{
    // legacy signals (best bid/ask, rvol, mom1, cache size)
    const sig = await (await fetch(`/signals?symbol=${encodeURIComponent(current)}`)).json();
    $('#bb').textContent = fmtNum(sig.best_bid, 2);
    $('#ba').textContent = fmtNum(sig.best_ask, 2);
    $('#cached').textContent = fmtNum(sig.trades_cached, 0);
    $('#mom1').textContent = fmtNum(sig.mom1_bps, 1);
    $('#rvol').textContent = fmtNum(sig.rvol_vs_recent, 2);

    // bars-based per-TF signals
    const tf = await (await fetch(`/signals_tf?symbol=${encodeURIComponent(current)}`)).json();
    $('#mom5').textContent = fmtNum(tf.mom_bps_5m, 1);
    $('#pxv').textContent = fmtNum(tf.px_vs_vwap_bps_1m, 1);

    // update trend score numbers from latest findings
    const findings = await (await fetch(`/findings?symbol=${encodeURIComponent(current)}&limit=5`)).json();
    const list = Array.isArray(findings.findings)? findings.findings : [];
    const ts = list.find(x => x.agent === 'trend_score');
    if (ts && ts.details){
      const d = ts.details;
      $('#p_up').textContent = fmtNum(d.p_up, 3);
      $('#p_breakdown').textContent = `p_1m=${fmtNum(d.p_1m,3)} · p_5m=${fmtNum(d.p_5m,3)} · p_15m=${fmtNum(d.p_15m,3)}`;
    }
  }catch(e){ console.error(e); }
}

// ---- fetch helpers ----
  async function jget(path, params={}) {
    const u = new URL(path, window.location.origin);
    for (const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
    const r = await fetch(u.toString(), {cache:'no-cache'});
    // If server ever returns HTML error, avoid JSON parse blowups
    const ct = r.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
      const text = await r.text();
      throw new Error(`Non-JSON response ${r.status}: ${text.slice(0,120)}`);
    }
    return r.json();
  }

 const fmtBps = n => (Number.isFinite(n) ? Math.round(n) : 0);
 const fmtNum = n => (Number.isFinite(n) ? n : 0);
 const pct    = x => (Number.isFinite(x) ? Math.round(x*100) : 0);
    
 // ---- updaters ----
  async function updateSignals() {
    const symbol = getSymbol();
    const data = await jget('/signals', {symbol});
    // header/footer basics
    if (bestBidEl)  bestBidEl.textContent = data.best_bid ?? '—';
    if (bestAskEl)  bestAskEl.textContent = data.best_ask ?? '—';
    if (tradesEl)   tradesEl.textContent  = data.trades_cached ?? 0;
    // if you also show “Price vs VWAP (bps)” from /signals (or take from /signals_tf below)
    if (cardPxv1m)  cardPxv1m.textContent = fmtBps(data.px_vs_vwap_bps);
    // momentum 1m on this endpoint is often sparse—prefer /signals_tf for the tiles
  }

  async function updateSignalsTF() {
    const symbol = getSymbol();
    const tf = await jget('/signals_tf', {symbol});
    if (cardMom1m) cardMom1m.textContent = fmtBps(tf.mom_bps_1m);
    if (cardMom5m) cardMom5m.textContent = fmtBps(tf.mom_bps_5m);
    // If you prefer px_vs_vwap from /signals_tf too:
    if (cardPxv1m && Number.isFinite(tf.px_vs_vwap_bps_1m)) {
      cardPxv1m.textContent = fmtBps(tf.px_vs_vwap_bps_1m);
    }
    if (cardRvol) {
      const r = tf.rvol_1m ?? 0;
      cardRvol.textContent = Number.isFinite(r) ? r.toFixed(2) : '0.00';
    }
  }

  async function updateTrend() {
    const symbol = getSymbol();

    // First try DB-backed finding
    try {
      const f = await jget('/findings', {symbol, agent:'trend_score', limit:1});
      if (f.findings && f.findings.length) {
        const row = f.findings[0];
        const d = row.details || {};
        if (cardTrend) cardTrend.textContent = pct(d.p_up ?? row.score);
        if (cardP1m)   cardP1m.textContent  = `p_1m=${pct(d.p_1m ?? 0)}`;
        if (cardP5m)   cardP5m.textContent  = `p_5m=${pct(d.p_5m ?? 0)}`;
        if (cardP15m)  cardP15m.textContent = `p_15m=${pct(d.p_15m ?? 0)}`;
        return; // success via DB
      }
    } catch (e) {
      // fall through to live
    }

    // Live fallback
    try {
      const live = await jget('/trend_now', {symbol});
      if (cardTrend) cardTrend.textContent = pct(live.p_up);
      if (cardP1m)   cardP1m.textContent  = `p_1m=${pct(live.p_1m)}`;
      if (cardP5m)   cardP5m.textContent  = `p_5m=${pct(live.p_5m)}`;
      if (cardP15m)  cardP15m.textContent = `p_15m=${pct(live.p_15m)}`;
    } catch (e) {
      if (cardTrend) cardTrend.textContent = '—';
    }
  }

  async function updateFindings(replace=false) {
    const symbol = getSymbol();
    const data = await jget('/findings', {symbol, limit: 30});
    // Simple re-render (or do incremental append if you track the last ts)
    if (findingsList) {
      findingsList.innerHTML = '';
      (data.findings || []).forEach(row => {
        const li = document.createElement('li');
        const {agent, score, ts_utc, label, details} = row;
        const rvol = details?.rvol ?? details?.rvol_1m ?? '';
        const mom1 = details?.mom1_bps ?? details?.mom_bps_1m ?? '';
        const pxvw = details?.px_vs_vwap_bps ?? details?.px_vs_vwap_bps_1m ?? '';
        li.textContent = `${label} • ${new Date(ts_utc).toLocaleTimeString()} — RVOL=${rvol} · mom1=${mom1} · px-vwap=${pxvw}`;
        findingsList.appendChild(li);
      });
    }
  }

  // ---- master refresh ----
  let timer = null;
  async function refreshAll(immediate=false) {
    // Cancel any pending timer during symbol switch
    if (timer) { clearTimeout(timer); timer = null; }

    try {
      await Promise.all([
        updateSignals(),
        updateSignalsTF(),
        updateTrend(),
        updateFindings(true),
      ]);
    } catch (e) {
      console.warn('refresh error', e);
    } finally {
      timer = setTimeout(refreshAll, 5000);
    }
  }

  // Boot
  refreshAll(true);
})();

    
function actionPill(act){
  const m = {observe:'', prepare:'', 'consider-entry':'ok', 'consider-exit':'warn'};
  const cls = m[act]||'';
  return `<span class="pill ${cls}">${esc(act)}</span>`;
}

function renderFinding(f){
  const d = f.details||{};
  const header = `<b>${esc(f.agent)}</b> • <span class="mono">${fmtNum(f.score,1)}</span> • <span class="muted mono">${new Date(f.ts_utc).toLocaleTimeString()}</span>`;

  if (f.agent==='llm_analyst'){
    let tweaks = '';
    if (Array.isArray(d.tweaks) && d.tweaks.length){
      tweaks = '<div class="muted" style="margin-top:4px">'+d.tweaks.slice(0,3).map(t=>`${esc(t.param)} ${t.delta>0?'+':''}${fmtNum(t.delta,2)} (${esc(t.reason||'')})`).join(' · ')+'</div>';
    }
    return `<div class="finding"><div>${header}</div>
      <div><b>Action:</b> ${actionPill(d.action||'observe')} <span class="muted">conf ${fmtNum(d.confidence,2)}</span></div>
      ${d.rationale ? `<div class="muted" style="margin:4px 0 0 2px">${esc(d.rationale)}</div>` : ''}
      ${tweaks}
    </div>`;
  }

  if (f.agent==='trend_score'){
    const p=d;
    return `<div class="finding"><div>${header}</div>
      <div class="muted mono" style="margin-top:4px">p_up=${fmtNum(p.p_up,3)} · p_1m=${fmtNum(p.p_1m,3)} · p_5m=${fmtNum(p.p_5m,3)} · p_15m=${fmtNum(p.p_15m,3)}</div>
    </div>`;
  }

  if (f.agent==='rvol_spike'){
    return `<div class="finding"><div>${header}</div>
      <div class="muted" style="margin-top:4px">RVOL=${fmtNum(d.rvol_1m5_vs20 ?? d.rvol,2)} · mom1=${fmtNum(d.mom_bps_1m,1)} · px-vwap=${fmtNum(d.px_vs_vwap_bps_1m,1)}</div>
    </div>`;
  }

  if (f.agent==='cvd_divergence' || f.agent==='cvd_div_bearish' || f.agent==='cvd_div_bullish'){
    const lab = f.agent.includes('bearish')?'Bearish':'Bullish';
    return `<div class="finding"><div>${header}</div>
      <div class="muted" style="margin-top:4px">${lab} price/CVD divergence</div>
    </div>`;
  }

  if (f.agent==='posture_guard' || f.agent==='posture_exit'){
    return `<div class="finding"><div>${header}</div>
      <div><b>Action:</b> ${actionPill(d.action||'consider-exit')} <span class="muted">conf ${fmtNum(d.confidence,2)}</span></div>
    </div>`;
  }

  if (f.agent==='session_reversal' || f.agent==='open_drive_reversal'){
    return `<div class="finding"><div>${header}</div>
      <div class="muted" style="margin-top:4px">Reversal prototype hit (ATR impulse + failure)</div>
    </div>`;
  }

  return `<div class="finding"><div>${header}</div></div>`;
}

async function fetchFindings(){
  try{
    const res = await (await fetch(`/findings?symbol=${encodeURIComponent(current)}&limit=50`)).json();
    const list = Array.isArray(res.findings)? res.findings : [];
    $('#findings').innerHTML = list.map(renderFinding).join('') || '<div class="muted">No findings yet.</div>';
  }catch(e){ console.error(e); }
}

async function fetchHealth(){
  try{
    const h = await (await fetch('/agents')).json();
    const now = Date.now();
    const stale = 60;
    $('#health').innerHTML = Object.entries(h.agents||{}).map(([agent,obj])=>{
      const age = obj.last_run ? (now-new Date(obj.last_run).getTime())/1000 : 9e9;
      const cls = age>stale ? 'stale' : 'ok';
      const label = age>stale ? 'STALE' : 'OK';
      return `<div class="agent"><div class="row"><div><b>${agent}</b></div><div class="${cls}">${label}</div></div>
        <div class="muted" style="margin-top:6px">Last run: ${obj.last_run?ago(obj.last_run):'—'}</div></div>`;
    }).join('');
  }catch(e){ console.error(e); }
}

init();
</script>
</body>
</html>
